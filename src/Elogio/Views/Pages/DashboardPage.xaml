<Page x:Class="Elogio.Views.Pages.DashboardPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:vm="clr-namespace:Elogio.ViewModels"
      xmlns:models="clr-namespace:Elogio.ViewModels.Models"
      mc:Ignorable="d"
      d:DesignHeight="700" d:DesignWidth="1000"
      Title="Dashboard"
      Loaded="Page_Loaded" d:DataContext="{d:DesignInstance vm:DashboardViewModel}">

    <Grid Margin="12,0,12,0">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Main Content -->
        <Grid Grid.Row="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" MinHeight="280" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Loading overlay -->
            <!-- <Grid Grid.RowSpan="2" -->
            <!--       Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}" -->
            <!--       Panel.ZIndex="1"> -->
            <!--     <Border Background="{ui:ThemeResource ApplicationBackgroundBrush}" Opacity="0.8" /> -->
            <!--     <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"> -->
            <!--         <ui:ProgressRing IsIndeterminate="True" Width="50" Height="50" /> -->
            <!--         <TextBlock Text="Loading..." Margin="0,16,0,0" /> -->
            <!--     </StackPanel> -->
            <!-- </Grid> -->

            <!-- Top Row: Today's Card (left) + Absent Colleagues (right) -->
            <Grid Grid.Row="0" Margin="0,0,0,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="300" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Today's Card -->
                <ui:Card Grid.Column="0" Margin="0,0,8,0" VerticalAlignment="Stretch"
                         VerticalContentAlignment="Stretch">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <!-- Today Header -->
                        <TextBlock Grid.Row="0"
                                   Text="Heute"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"
                                   Margin="0,0,0,12" />

                        <!-- Today's Balance -->
                        <Border Grid.Row="1"
                                Background="{ui:ThemeResource ControlFillColorSecondaryBrush}"
                                CornerRadius="8"
                                Padding="16"
                                Margin="0,0,0,12">
                            <StackPanel HorizontalAlignment="Center">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <TextBlock Text="{Binding TodayWorkedText}"
                                               FontSize="32"
                                               FontWeight="Bold"
                                               Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}" />
                                    <TextBlock Text="{Binding TodayExpectedText}"
                                               FontSize="18"
                                               Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                               VerticalAlignment="Bottom"
                                               Margin="8,0,0,4" />
                                </StackPanel>
                                <TextBlock Text="{Binding TodayDifferenceText}"
                                           FontSize="14"
                                           Foreground="{Binding TodayDifferenceBrush}"
                                           HorizontalAlignment="Center"
                                           Margin="0,4,0,0" />
                            </StackPanel>
                        </Border>

                        <!-- Time Entries -->
                        <StackPanel Grid.Row="2"
                                    Visibility="{Binding HasTimeEntries, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="Buchungen"
                                       FontSize="13"
                                       FontWeight="Medium"
                                       Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                       Margin="0,0,0,8" />
                            <ItemsControl ItemsSource="{Binding TimeEntries}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="{x:Type models:TimeEntryDisplayItem}">
                                        <Border Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
                                                CornerRadius="4"
                                                Padding="12,8"
                                                Margin="0,4">
                                            <TextBlock Text="{Binding DisplayText}"
                                                       FontSize="14"
                                                       FontFamily="Consolas"
                                                       HorizontalAlignment="Center"
                                                       Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}" />
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- No Entries Message -->
                        <TextBlock Grid.Row="2"
                                   Text="Noch keine Buchungen heute"
                                   FontSize="13"
                                   Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Visibility="{Binding HasTimeEntries, Converter={StaticResource InverseBoolToVisibilityConverter}}" />

                        <!-- Separator -->
                        <Border Grid.Row="3"
                                Height="1"
                                Background="{ui:ThemeResource ControlStrokeColorDefaultBrush}"
                                Margin="0,12" />

                        <!-- Punch Buttons -->
                        <Grid Grid.Row="4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <ui:Button Grid.Column="0"
                                       Content="KOMMEN"
                                       Appearance="Success"
                                       HorizontalAlignment="Stretch"
                                       Margin="0,0,8,0"
                                       Padding="12,8"
                                       FontWeight="SemiBold"
                                       Command="{Binding PunchKommenCommand}"
                                       IsEnabled="{Binding IsKommenEnabled}">
                                <ui:Button.Icon>
                                    <ui:SymbolIcon Symbol="ArrowCircleRight24" />
                                </ui:Button.Icon>
                            </ui:Button>

                            <ui:Button Grid.Column="1"
                                       Content="GEHEN"
                                       Appearance="Danger"
                                       HorizontalAlignment="Stretch"
                                       Margin="8,0,0,0"
                                       Padding="12,8"
                                       FontWeight="SemiBold"
                                       Command="{Binding PunchGehenCommand}"
                                       IsEnabled="{Binding IsGehenEnabled}">
                                <ui:Button.Icon>
                                    <ui:SymbolIcon Symbol="ArrowCircleLeft24" />
                                </ui:Button.Icon>
                            </ui:Button>
                        </Grid>
                    </Grid>
                </ui:Card>

                <!-- Absent Colleagues Card -->
                <ui:Card Grid.Column="1" Margin="8,0,0,0" VerticalAlignment="Stretch"
                         VerticalContentAlignment="Top">
                    <Grid VerticalAlignment="Top">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!-- Header -->
                        <TextBlock Grid.Row="0"
                                   Text="Abwesende Kollegen"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"
                                   Margin="0,0,0,12" />

                        <!-- Colleagues List -->
                        <ScrollViewer Grid.Row="1" VerticalAlignment="Top">
                            <StackPanel>
                                <ItemsControl ItemsSource="{Binding AbsentColleagues}"
                                              Visibility="{Binding HasAbsentColleagues, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate DataType="{x:Type models:AbsentColleagueItem}">
                                            <Border Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
                                                    CornerRadius="6"
                                                    Padding="12"
                                                    Margin="0,4">
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="Auto" />
                                                    </Grid.RowDefinitions>

                                                    <StackPanel Grid.Row="0" Orientation="Horizontal">
                                                        <ui:SymbolIcon Symbol="Person24"
                                                                       Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                                                       Margin="0,0,8,0" />
                                                        <TextBlock Text="{Binding Name}"
                                                                   FontWeight="Medium"
                                                                   FontSize="14"
                                                                   Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}" />
                                                    </StackPanel>

                                                    <StackPanel Grid.Row="1" Margin="28,4,0,0">
                                                        <TextBlock FontSize="12"
                                                                   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}">
                                                            <Run Text="{Binding AbsenceInfo}" />
                                                            <Run Text=" - " />
                                                            <Run Text="{Binding ReturnDate}" />
                                                        </TextBlock>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- No colleagues message -->
                                <StackPanel VerticalAlignment="Center"
                                            HorizontalAlignment="Center"
                                            Margin="0,32"
                                            Visibility="{Binding HasAbsentColleagues, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                    <ui:SymbolIcon Symbol="People24"
                                                   FontSize="32"
                                                   Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"
                                                   HorizontalAlignment="Center" />
                                    <TextBlock Text="Alle Kollegen anwesend"
                                               FontSize="13"
                                               Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"
                                               HorizontalAlignment="Center"
                                               Margin="0,8,0,0" />
                                </StackPanel>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>
                </ui:Card>
            </Grid>

            <!-- Bottom Row: Week Overview (horizontal) -->
            <ui:Card Grid.Row="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- Week Header -->
                    <StackPanel Grid.Row="0" Margin="0,0,0,16">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Wochenansicht"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}" />
                            <TextBlock Text="{Binding CalendarWeekDisplay}"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                       Margin="8,0,0,0" />
                        </StackPanel>
                        <TextBlock Text="{Binding WeekRangeDisplay}"
                                   FontSize="12"
                                   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                   Margin="0,4,0,0" />
                    </StackPanel>

                    <!-- Week Days List (Horizontal) -->
                    <ItemsControl Grid.Row="1" ItemsSource="{Binding WeekDays}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Rows="1" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type models:DayOverviewItem}">
                                <Border Margin="4" Padding="12" CornerRadius="8">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background"
                                                    Value="{ui:ThemeResource ControlFillColorDefaultBrush}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsToday}" Value="True">
                                                    <Setter Property="Background"
                                                            Value="{ui:ThemeResource ControlFillColorSecondaryBrush}" />
                                                    <Setter Property="BorderBrush"
                                                            Value="{ui:ThemeResource SystemAccentColorPrimaryBrush}" />
                                                    <Setter Property="BorderThickness" Value="2" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding State}"
                                                             Value="{x:Static models:DayOverviewState.MissingEntry}">
                                                    <Setter Property="Background" Value="#20F44336" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <StackPanel HorizontalAlignment="Center">
                                        <!-- Day indicator -->
                                        <TextBlock Text="{Binding DayName}"
                                                   FontWeight="SemiBold"
                                                   FontSize="14"
                                                   HorizontalAlignment="Center">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground"
                                                            Value="{ui:ThemeResource TextFillColorPrimaryBrush}" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsToday}" Value="True">
                                                            <Setter Property="Foreground"
                                                                    Value="{ui:ThemeResource SystemAccentColorPrimaryBrush}" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        <TextBlock Text="{Binding DayNumber}"
                                                   FontSize="11"
                                                   Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"
                                                   HorizontalAlignment="Center"
                                                   Margin="0,2,0,8" />

                                        <!-- Time info -->
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding WorkedDisplay}" VerticalAlignment="Bottom"
                                                       FontSize="16"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"
                                                       HorizontalAlignment="Center" />
                                            <TextBlock Text="{Binding ExpectedDisplay}" VerticalAlignment="Bottom"
                                                       FontSize="11"
                                                       Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"
                                                       HorizontalAlignment="Center"
                                                       Margin="5,0,0,0" />
                                        </StackPanel>
                                        
                                        <!-- Difference -->
                                        <TextBlock Text="{Binding DifferenceDisplay}"
                                                   FontSize="13"
                                                   FontWeight="Medium"
                                                   HorizontalAlignment="Center"
                                                   Margin="0,6,0,0"
                                                   Foreground="{Binding DifferenceBrush}">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding State}"
                                                                     Value="{x:Static models:DayOverviewState.Future}">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>

                                        <!-- Absence label if applicable -->
                                        <TextBlock Text="{Binding AbsenceLabel}"
                                                   FontSize="10"
                                                   Foreground="#00BCD4"
                                                   HorizontalAlignment="Center"
                                                   Margin="0,4,0,0"
                                                   Visibility="{Binding HasAbsence, Converter={StaticResource BoolToVisibilityConverter}}" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Week Summary -->
                    <Border Grid.Row="2"
                            Background="{ui:ThemeResource ControlFillColorSecondaryBrush}"
                            CornerRadius="6"
                            Padding="16"
                            Margin="0,16,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                                <TextBlock Text="Gearbeitet"
                                           FontSize="11"
                                           Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                           HorizontalAlignment="Center" />
                                <TextBlock Text="{Binding WeeklyWorkedDisplay}"
                                           FontSize="18"
                                           FontWeight="SemiBold"
                                           HorizontalAlignment="Center" />
                            </StackPanel>

                            <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                                <TextBlock Text="Erwartet"
                                           FontSize="11"
                                           Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                           HorizontalAlignment="Center" />
                                <TextBlock Text="{Binding WeeklyExpectedDisplay}"
                                           FontSize="18"
                                           FontWeight="SemiBold"
                                           HorizontalAlignment="Center" />
                            </StackPanel>

                            <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                                <TextBlock Text="Wochensaldo"
                                           FontSize="11"
                                           Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                           HorizontalAlignment="Center" />
                                <TextBlock Text="{Binding WeeklyBalanceDisplay}"
                                           FontSize="18"
                                           FontWeight="SemiBold"
                                           Foreground="{Binding WeeklyBalanceBrush}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </ui:Card>
        </Grid>

        <!-- Error message -->
        <ui:InfoBar Grid.Row="1"
                    Title="Fehler"
                    Message="{Binding ErrorMessage}"
                    Severity="Error"
                    IsOpen="{Binding ErrorMessage, Converter={StaticResource NullToVisibilityConverter}}"
                    IsClosable="True"
                    VerticalAlignment="Bottom"
                    Margin="0,16,0,0"
                    Visibility="{Binding ErrorMessage, Converter={StaticResource NullToVisibilityConverter}}" />
    </Grid>
</Page>